---

- name: Pull nextcloud_passwordsalt
  shell: aws ssm get-parameters --with-decryption --names {{ nextcloud_ssm_path }}/nextcloud_passwordsalt --region "eu-west-2" --query "Parameters[0]"."Value" | sed 's:^.\(.*\).$:\1:'
  register: nextcloud_passwordsalt


- name: Pull nextcloud_secret
  shell: aws ssm get-parameters --with-decryption --names {{ nextcloud_ssm_path }}/nextcloud_secret --region "eu-west-2" --query "Parameters[0]"."Value" | sed 's:^.\(.*\).$:\1:'
  register: nextcloud_secret


- name: Pull nextcloud_dbuser
  shell: aws ssm get-parameters --with-decryption --names {{ nextcloud_ssm_path }}/nextcloud_dbuser --region "eu-west-2" --query "Parameters[0]"."Value" | sed 's:^.\(.*\).$:\1:'
  register: nextcloud_dbuser


- name: Pull nextcloud_dbpassword
  shell: aws ssm get-parameters --with-decryption --names {{ nextcloud_ssm_path }}/nextcloud_dbpassword --region "eu-west-2" --query "Parameters[0]"."Value" | sed 's:^.\(.*\).$:\1:'
  register: nextcloud_dbpassword


- name: Pull nextcloud_s01ldap_agent_password
  shell: aws ssm get-parameters --with-decryption --names {{ nextcloud_ssm_path }}/nextcloud_s01ldap_agent_password --region "eu-west-2" --query "Parameters[0]"."Value" | sed 's:^.\(.*\).$:\1:'
  register: nextcloud_s01ldap_agent_password


- name: Pull nextcloud_id
  shell: aws ssm get-parameters --with-decryption --names {{ nextcloud_ssm_path }}/nextcloud-id --region "eu-west-2" --query "Parameters[0]"."Value" | sed 's:^.\(.*\).$:\1:'
  register: nextcloud_id


- name: Create our Nextcloud config file for import
  template:
    src: "{{ role_path }}/templates/nextcloud-conf.json.j2"
    dest: "{{ import_config_file }}"
    owner: "{{ web_user }}"
    mode: "0644"
    group: "{{ web_group }}"

- name: Create our data directory
  file:
    path: "{{ data_dir}}"
    state: directory
    group: "{{ web_group }}"
    mode: "0770"
    owner: "{{ web_user }}"

- name: Create our ocdata file
  file:
    path: "{{ data_dir}}.ocdata"
    state: touch
    group: "{{ web_group }}"
    mode: "0644"
    owner: "{{ web_user }}"

- name: create NC log directory
  file:
    path: "/var/log/nextcloud"
    state: directory
    group: "{{ web_group }}"
    mode: "0640"
    owner: "{{ web_user }}"
    recurse: yes

- name: Create our Nextcloud logrotate conf
  template:
    src: "{{ role_path }}/templates/nclogrotate.j2"
    dest: "/etc/logrotate.d/{{ app_name }}"
    owner: "root"
    mode: "0644"
    group: "root"

- name: Create our Nextcloud importer script
  template:
    src: "{{ role_path }}/templates/import-config.sh.j2"
    dest: "{{ config_sh_script }}"
    mode: u+x

- name: Import our Nextcloud config
  shell: "{{ config_sh_script }} > /var/log/nextcloud-import.log"
  args:
    creates: /var/log/nextcloud-import.log
