#!/usr/bin/env bash

NEXTCLOUD_ADMIN_PASSWORD=$(aws ssm get-parameters --with-decryption --names "{{ nextcloud_user_param }}" --region "{{ region }}" --query "Parameters[0]"."Value" | sed 's:^.\(.*\).$:\1:')

cd {{ nextcloud_dir }}
chown -R {{ web_user }}:{{ web_user }} {{ data_dir }}
sudo -u {{ web_user }} php occ ldap:delete-config s01
sudo -u {{ web_user }} php occ ldap:create-empty-config
sudo -u {{ web_user }} php occ   config:import   ~{{ web_user }}/{{ NEXTCLOUD_CONF }}

export OC_PASS="$NEXTCLOUD_ADMIN_PASSWORD"
su -s /bin/sh {{ web_user }} -c "php occ user:resetpassword --password-from-env {{ nextcloud_admin }}"
